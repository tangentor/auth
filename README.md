# 分布式环境下统一动态鉴权方案
## 1. 简介
在数字化转型的浪潮中，企业正逐步采用微服务架构和云原生技术，以提高系统的敏捷性和可扩展性。然而，随着服务数量的增加和业务逻辑的复杂化，如何确保服务间调用的安全性和接口权限的合理控制成为了一个挑战。本方案正是在这样的背景下应运而生，提供了一种轻量级、无侵入式的动态鉴权机制，以策略模式为核心，确保了权限管理的灵活性和扩展性，同时兼顾了系统的安全性。
### 项目亮点：
- **轻量化设计**：减少系统资源消耗，提升响应速度。
- **无侵入式集成**：最小化对现有业务逻辑的干扰。
- **动态权限管理**：实时响应权限变更，无需重启服务。
- **策略模式应用**：灵活切换不同的权限验证策略。
## 2. 方案构成
### 客户端（Client）
客户端作为一个Spring Boot Starter，可以在应用启动时自动集成并扫描所有接口的权限信息。以下是客户端的主要构建思想：
1. **非侵入式配置**：通过注解`@NotRequireAuth`和`@RequireAuth`以及配置文件来标记接口是否需要鉴权，无需修改原有代码逻辑。
2. **策略模式**：通过实现`AuthStrategy`接口，可以自定义鉴权策略，默认策略为`DefaultAuthStrategy`或者`ConfigurableAuthStrategy`。
3. **配置加载**：通过`@ConfigurationProperties`注解，可以动态加载配置文件中的权限信息，实现`ConfigurableAuthStrategy`。
4. **心跳机制**：客户端通过定时发送心跳来更新权限信息。
5. **延迟注册**：可以实现服务端自我权限管理。
### 服务器端（Server）
服务器端负责接收客户端注册的权限信息，并维护一个权限注册表。以下是服务器端的主要构建思想：
1. **心跳机制**：服务器端通过心跳来判断客户端的在线状态以及权限变更情况。
2. **服务发现**：使用Nacos等服务发现组件来动态获取服务器端的地址。
3. **权限注册与注销**：客户端上线时注册权限信息，下线时自动注销。
4. **热启动**：当server端重启时会热加载redis中的已经保存的重启前的权限信息恢复之前的运行状态。
5. **Raft一致性同步**：当有多台Server需要进行数据同步时，使用Raft算法（SOFAJRaft）实现去中心化的主从数据同步。
## 3. 应用场景
- **微服务间鉴权**：确保服务间调用的安全性。
- **分布式接口管理**：统一管理分布式系统中的接口权限。
- **动态权限调整**：适用于权限策略需要频繁变动的环境。
## 4. 方案亮点
### 4.1 轻量化与高性能
本方案的设计哲学之一是追求轻量化和高性能。通过使用Redis作为缓存和消息队列系统，以及采用异步调用的方式，我们有效地减少了鉴权操作对系统性能的影响。Redis的高效数据读写能力和支持多种数据结构的特性，使得权限信息的存储和检索变得快速而高效。异步调用则允许主线程快速返回，从而提高整体系统的响应速度。
### 4.2 无侵入式集成
为了最小化对现有业务逻辑的干扰，我们采用了无侵入式的集成方式。这包括使用Spring的注解功能来标记需要鉴权的接口，以及通过配置文件来定义权限策略。这种集成方式允许开发者在不修改原有代码的情况下，轻松地集成鉴权逻辑，提高了开发效率。
### 4.3 动态管理与实时更新
本方案的另一个核心设计理念是动态管理与实时更新。通过心跳机制，客户端能够实时向服务器端发送权限信息，服务器端则根据这些信息来动态调整权限状态。此外，我们提供了管理端，允许管理员在不重启应用的情况下，动态地修改应用的权限信息，从而实现了不停机权限更新。
### 4.4 策略模式的灵活性
策略模式的应用使得本方案能够根据不同的业务场景和安全需求，灵活地切换不同的权限验证策略。通过实现`AuthStrategy`接口，开发者可以自定义不同的鉴权逻辑，从而满足各种复杂场景的需求。
## 5. 使用说明
### 5.1 客户端集成
客户端集成是实现动态鉴权的第一步，涉及依赖引入、注解启用和配置项设置。
#### 5.1.1 引入依赖
在项目的`pom.xml`文件中添加客户端依赖，以便使用Spring Boot Starter进行权限控制。
由于目前还处于开发阶段，该依赖仅存在我的内网私服上，所以需要提前自行编译
```xml
<dependency>
    <groupId>cn.swunlp</groupId>
    <artifactId>backend-base-security</artifactId>
</dependency>
```
#### 5.1.2 启用配置
通过`@EnableAuthConfiguration`注解启用权限配置，支持延迟注册和调试模式，以适应不同的需求。
```java
@EnableAuthConfiguration(delayRegister = true, debug = true)
```
#### 5.1.3 配置文件
在配置文件中设置应用名称、代码、角色和权限等参数，以定义应用的鉴权策略。
```yaml
security:
  access-control:
    enable: true
  auth:
    app:
      name: xxx 
      code: xxx
    strategy:
      roles: xxx
      permissions: xxx
      enable: true
```
code与name可以在服务启动后通过api接口进行获取（第一次启动不要开启Server的自我鉴权）

### 5.2 权限策略
权限策略是动态鉴权的核心，通过注解和配置策略实现灵活的权限控制。
#### 5.2.1 默认策略
`DefaultAuthStrategy`类提供了一种无需权限验证的默认策略，适用于开放性接口。
#### 5.2.2 配置策略
`ConfigurableAuthStrategy`类允许根据配置文件动态调整权限验证逻辑，体现了方案的灵活性。
### 5.3 注册与鉴权流程
注册与鉴权流程是动态鉴权方案的执行过程，包括应用注册、心跳机制和鉴权逻辑。
#### 5.3.1 应用注册
客户端在启动时将应用权限信息封装并注册到服务器端，以便进行统一管理。
#### 5.3.2 心跳机制
客户端通过定期发送心跳包，确保其权限信息在服务器端的实时性和有效性。
#### 5.3.3 鉴权流程
服务器端接收请求后，匹配路由权限，根据用户凭证和应用权限信息进行综合鉴权。
### 5.4 高级特性
#### 5.4.1 细粒度的权限控制
本方案支持对每个接口进行细粒度的权限设置，包括方法级别和类级别的权限控制。
#### 5.4.2 角色和权限的动态组合
通过策略模式，本方案能够灵活地组合角色和权限，以适应复杂的业务场景。
#### 5.4.3 安全性增强
除了基本的鉴权逻辑，本方案还提供了额外的安全特性，如访问控制列表（ACL）、令牌过期策略等。

## 6. 效果预览

### 提供API对外暴露，可以基于此进行二次开发集成到现有的监控平台上
![image.png](https://file.vitangx.cn//blog/20240716122416.png)
![image.png](https://file.vitangx.cn//blog/20240716123056.png)

### 权限信息定时定量存储到Redis中，Redis再做持久化与过期管理
![image.png](https://file.vitangx.cn//blog/20240716122720.png)

### 在server端启动后不开启访问控制，可以进行应用的申请获取应用码
![image.png](https://file.vitangx.cn//blog/20240716122858.png)

### 开启访问控制后，默认不允许直接访问到该应用
![image.png](https://file.vitangx.cn//blog/20240716122813.png)

### 可以通过注解对特定接口进行放行，如网关鉴权与应用注册的实现方式
```java
    /**
     * 接收注册请求
     */
    @PostMapping("/register")
    @NotRequireAuth(isPublic = true)
    public AppRegisterResult register(@RequestBody ApplicationPermission applicationPermission) {
        return registerService.register(applicationPermission);
    }
```